<!DOCTYPE html>
<html lang="en">

<head>
    <title>MediathekViewWeb</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../static/index.css">
    <link rel="stylesheet" href="../../static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../static/DataTables/datatables.min.css" />
    <link rel="stylesheet" href="../../static/video-js.min.css" />
    <link rel="stylesheet" href="../../static/bootstrap-multiselect.css" />
    <script src="../../static/jquery.min.js"></script>
    <script src="../../static/js.cookie.js"></script>
    <script src="../../static/bootstrap/js/bootstrap.min.js"></script>
    <script src="../../socket.io/socket.io.js"></script>
    <script src="../../static/moment-with-locales.min.js"></script>
    <script src="../../static/DataTables/datatables.min.js"></script>
    <script src="../../static/video.min.js"></script>
    <script src="../../static/underscore-min.js"></script>
    <script src="../../static/bootbox.min.js"></script>
    <script src="../../static/bootstrap-multiselect.js"></script>
</head>

<script>
    var socket = io();
    var mediathekTable;
    var websiteNames = [];
    var selectedWebsiteNames = new Set();
    var websiteNamesMultiselectChangedWhileOpen = false;
    var connectingModal;
    var indexingModal;
    var uid;
    var pv_id;

    var locale = window.navigator.userLanguage || window.navigator.language;
    moment.locale(locale);

    function modalIsOpen(modalDOM) {
        return (modalDOM.data('bs.modal') || {}).isShown;
    }

    function randomString(len) {
        var text = "";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

        for (var i = 0; i < len; i++)
            text += possible.charAt(Math.floor(Math.random() * possible.length));

        return text;
    }

    function formatBytes(bytes, decimals) {
        if (bytes == 0) return '0 Byte';
        var k = 1000;
        var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
    }

    pv_id = randomString(6);

    function track(action) {
        socket.emit('track', {
            uid: uid,
            pv_id: pv_id,
            ua: navigator.userAgent,
            lang: navigator.language,
            res: window.screen.width + "x" + window.screen.height,
            e_c: 'MediathekViewWeb',
            e_a: action
        });
    }

    if (typeof(Storage) !== "undefined") {
        uid = localStorage.getItem('uid');
    }
    if (!!uid) {
        uid = uid.trim();
    } else {
        uid = Cookies.get('uid');
        if (!!uid) {
            uid = uid.trim();
        }
    }
    if (!!uid && uid.length == 32) {
        track('index');
    } else {
        socket.on('uid', (_uid) => {
            localStorage.setItem('uid', _uid);
            Cookies.set('uid', _uid, {
                expires: 99999
            });
            uid = _uid;

            track('index');
        });
        socket.emit('requestUid');
    }

    setInterval(() => {
        if (socket.connected) {
            track('heartbeat');
        }
    }, 3 * 60 * 1000); //every 3 minutes

    socket.on('indexState', (state) => {
        let progress = (state.progress * 100).toFixed(0);
        $('#indexingProgressbar').css('width', (progress + '%')).text(progress + '%');
        $('#indexingEntriesLabel').text(state.entries);
        $('#indexingIndicesLabel').text(state.indices);
        $('#indexingTimeLabel').text((state.time / 1000).toFixed(0) + ' Sekunden');


        if (!state.done) {
            if (!modalIsOpen(indexingModal)) {
                indexingModal.modal('show');
            }
        } else {
            socket.emit('getWebsiteNames');
            indexingModal.modal('hide');
        }
    });

    function trackQuery() {
        trackQuery = _.debounce(() => {
            track('query');
        }, 2000);
        trackQuery();
    }

    function query() {
        query = _.throttle(() => {
            let queryString = $('#queryInput').val();
            let mode = $('#queryField input:radio:checked').val();

            socket.emit('queryEntry', {
                queryString: queryString,
                mode: mode,
                filters: {
                    websiteNames: Array.from(selectedWebsiteNames)
                }
            });

            trackQuery();
        }, 250);
        query();
    }

    socket.on('websiteNames', (websites) => {
        websites = websites.sort();
        websiteNames = websites;
        let multiselect = $('#websiteNamesMultiselect');

        let data = [];
        for (var i = 0; i < websites.length; i++) {
            data.push({
                label: websites[i],
                title: websites[i],
                value: websites[i],
                selected: true
            });
            selectedWebsiteNames.add(websites[i]);
        }

        multiselect.multiselect('dataprovider', data);

        //$('#websiteNamesMultiselect').multiselect('rebuild');
    });

    socket.on('queryResult', (result) => {
        mediathekTable.clear();

        for (var i = 0; i < result.results.length; i++) {
            let data = result.results[i].data;
            data.dateString = moment.unix(data.timestamp).format('L');
            data.timeString = moment.unix(data.timestamp).format('LT');
            data.durationString = isNaN(data.duration) ? '?' : moment.unix(data.duration - 3600).format('LT');

            mediathekTable.row.add(data);
        }

        mediathekTable.draw();

        $('#queryInfoLabel').text('Die Suchmaschine brauchte ' + result.queryInfo.searchEngineTime + ' ms, das Filtern von ' + result.queryInfo.resultCount +
            ' Ergebnissen und das Sotieren nach Relevanz dauerte ' + result.queryInfo.filterTime + ' ms.');
    });

    function createPlayButton(text, videoTitle, videoUrl) {
        return $('<a>', {
            target: '_blank',
            text: text,
            href: videoUrl,
            click: () => {
                playVideo(videoTitle, videoUrl);
                return false;
            }
        });
    }

    function playVideo(title, url) {
        var dialog = bootbox.dialog({
            title: title,
            message: '<video class="video-js" controls preload="auto"><source src="' + url + '" type="video/mp4"></video>',
            backdrop: true,
            onEscape: true
        });
        track('play');
    }

    function returnEmptyString() {
        return '';
    }

    $(function() {
        connectingModal = $('#connectingModal');
        connectingModal.modal({
            backdrop: 'static',
            keyboard: false
        });

        indexingModal = $('#indexingModal');
        indexingModal.modal({
            backdrop: 'static',
            keyboard: false,
            show: false
        });

        socket.on('connect', () => {
            connectingModal.modal('hide');
        });

        socket.on('disconnect', () => {
            indexingModal.modal('hide');
            if (!modalIsOpen(connectingModal)) {
                connectingModal.modal('show');
            }
        });

        if (socket.disconnected) {
            if (!modalIsOpen(connectingModal)) {
                connectingModal.modal('show');
            }
        }

        mediathekTable = $('#mediathek').DataTable({
            columns: [{ //Website
                width: "10%",
                data: null,
                render: returnEmptyString,
                createdCell: (td, cellData, rowData, row, col) => {
                    let link = $('<a>', {
                        target: '_blank',
                        text: rowData.websiteName,
                        href: rowData.url_website
                    });
                    $(td).append(link);
                }
            }, { //Title
                data: 'title'
            }, { //Date
                width: "7%",
                data: 'dateString'
            }, { //Time
                width: "6%",
                data: 'timeString'
            }, { //Duration
                width: "6%",
                data: 'durationString'
            }, { //Size
                width: "6%",
                data: 'size',
                render: (data, type, obj) => {
                    if (type == 'display') {
                        return isNaN(data) ? '?' : formatBytes(data, 2);
                    }
                }
            }, { //Video
                width: '8%',
                data: null,
                render: returnEmptyString,
                createdCell: (td, cellData, rowData, row, col) => {
                    let sdButton = createPlayButton('', rowData.title, rowData.url_video_low);
                    let sdIcon = $('<span>').addClass('glyphicon glyphicon-sd-video glyph-big glyph-margin-right');
                    sdButton.append(sdIcon);
                    if (!rowData.url_video_low) sdButton.css('visibility', 'hidden');

                    let mButton = createPlayButton('', rowData.title, rowData.url_video);
                    let mIcon = $('<span>').addClass('glyphicon glyphicon-film glyph-big glyph-margin-left glyph-margin-right');
                    mButton.append(mIcon);
                    if (!rowData.url_video) mButton.css('visibility', 'hidden');

                    let hdButton = createPlayButton('', rowData.title, rowData.url_video_hd);
                    let hdIcon = $('<span>').addClass('glyphicon glyphicon-hd-video glyph-big glyph-margin-left');
                    hdButton.append(hdIcon);
                    if (!rowData.url_video_hd) hdButton.css('visibility', 'hidden');

                    $(td).append(sdButton).append(mButton).append(hdButton);
                }
            }],
            language: {
                url: "/static/dataTables.german.lang"
            },
            searching: false,
            ordering: false,
            info: true
        });

        $('#websiteNamesMultiselect').multiselect({
            enableClickableOptGroups: true,
            disableIfEmpty: true,
            disabledText: 'none available',
            includeSelectAllOption: true,
            selectAllValue: 'select-all',
            onChange: (option, checked, select) => {
                if (option == undefined) {
                    if (!checked) selectedWebsiteNames.clear();
                    else selectedWebsiteNames = new Set(websiteNames);
                } else {
                    let website = option[0].value;

                    if (checked) {
                        selectedWebsiteNames.add(website);
                    } else {
                        selectedWebsiteNames.delete(website);
                    }
                }
                websiteNamesMultiselectChangedWhileOpen = true;
                query();
            },
            onDropdownHide: () => {
                if (websiteNamesMultiselectChangedWhileOpen) {
                    //query();
                    websiteNamesMultiselectChangedWhileOpen = false;
                }
            },
            buttonText: (options, select) => {
                if (options.length === 0) {
                    return 'Webseiten';
                } else if (options.length > 3) {
                    return options.length + ' Webseiten ausgewählt';
                } else if (options.length == websiteNames.length) {
                    return 'Alle Webseiten';
                } else {
                    var labels = [];
                    options.each(function() {
                        if ($(this).attr('label') !== undefined) {
                            labels.push($(this).attr('label'));
                        } else {
                            labels.push($(this).html());
                        }
                    });
                    return labels.join(', ') + '';
                }
            }
        });

        socket.emit('getWebsiteNames');

        $('#queryInput').on('input', () => query());
        $('#queryField input:radio').change(() => query());
    });
</script>

<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">MediathekViewWeb</a>
            </div>
            <ul class="nav navbar-nav">
            </ul>
        </div>
    </nav>

    <div class="container">

        <div class="input-group" id="queryField">
            <span class="input-group-addon">Suche</span>
            <input type="text" class="form-control" id="queryInput">

            <span class="input-group-addon">
              <input type="radio" name="searchmode" value="and" id="andRadioButton" checked> UND</input>
            </span>

            <span class="input-group-addon">
              <input type="radio" name="searchmode" value="or" id="orRadioButton"> ODER</input>
            </span>
        </div>

        <br>

        <div class="panel panel-default">
            <div class="panel-heading">Filter</div>
            <div class="panel-body">
                <select id="websiteNamesMultiselect" multiple="multiple">
                </select>
            </div>
        </div>

        <br>

        <table id="mediathek" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Webseite</th>
                    <th>Titel</th>
                    <th>Datum</th>
                    <th>Zeit</th>
                    <th>Dauer</th>
                    <th>Größe</th>
                    <th>Video</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <label id="queryInfoLabel"></label>

        <div id="connectingModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Keine Verbindung...</h4>
                    </div>
                    <div class="modal-body">
                        <span class="glyphicon glyphicon-repeat spinning"></span> Verbinden...
                    </div>
                </div>

            </div>
        </div>

        <div id="indexingModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Datenbank wird aktualisiert...</h4>
                    </div>
                    <div class="modal-body">
                        <div class="progress">
                            <div id="indexingProgressbar" class="progress-bar progress-bar-striped active" role="progressbar" style="min-width: 2em;">
                                0%
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4">Einträge:
                                <div id="indexingEntriesLabel">0</div>
                            </div>
                            <div class="col-sm-4">Indizes:
                                <div id="indexingIndicesLabel">0</div>
                            </div>
                            <div class="col-sm-4">Dauer:
                                <div id="indexingTimeLabel">0</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script type="text/javascript">
    </script>
</body>


</html>
