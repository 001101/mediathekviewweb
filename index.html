<!DOCTYPE html>
<html lang="en">

<head>
    <title>MediathekViewWeb</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../static/DataTables/datatables.min.css" />
    <link rel="stylesheet" href="../../static/video-js.min.css" />
    <link rel="stylesheet" href="../../static/bootstrap-multiselect.css" />
    <script src="../../static/jquery.min.js"></script>
    <script src="../../static/bootstrap/js/bootstrap.min.js"></script>
    <script src="../../socket.io/socket.io.js"></script>
    <script src="../../static/moment-with-locales.min.js"></script>
    <script src="../../static/DataTables/datatables.min.js"></script>
    <script src="../../static/video.min.js"></script>
    <script src="../../static/bootbox.min.js"></script>
    <script src="../../static/bootstrap-multiselect.js"></script>
</head>

<script>
    var socket = io();
    var mediathekTable;
    var websiteNames = [];
    var selectedWebsiteNames = new Set();
    var websiteNamesMultiselectChangedWhileOpen = false;

    var locale = window.navigator.userLanguage || window.navigator.language;
    moment.locale(locale);

    function formatBytes(bytes, decimals) {
        if (bytes == 0) return '0 Byte';
        var k = 1000;
        var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
    }

    function query() {
        let queryString = $('#queryInput').val();
        let mode = $('#queryField input:radio:checked').val();

        socket.emit('queryEntry', {
            queryString: queryString,
            mode: mode,
            filters: {
                websiteNames: Array.from(selectedWebsiteNames)
            }
        });
    }

    socket.on('websiteNames', (websites) => {
      websites = websites.sort();
        websiteNames = websites;
        let multiselect = $('#websiteNamesMultiselect');

        let data = [];
        for (var i = 0; i < websites.length; i++) {
            data.push({
                label: websites[i],
                title: websites[i],
                value: websites[i],
                selected: true
            });
            selectedWebsiteNames.add(websites[i]);
        }

        multiselect.multiselect('dataprovider', data);

        //$('#websiteNamesMultiselect').multiselect('rebuild');
    });

    socket.on('queryResult', (result) => {
        mediathekTable.clear();
        let data = result.data;

        for (var i = 0; i < data.length; i++) {
            let dateTime = moment.unix(data[i].data.timestamp);
            mediathekTable.row.add(['<a target="_blank" href="' + data[i].data.url_website + '">' + data[i].data.websiteName + '</a>', data[i].data.title, dateTime.format('L'), dateTime.format('LT'), data[i].data.duration,
                formatBytes(data[i].data.size), createPlayButton(data[i].data.title, data[i].data.url_video) /*'<a target="_blank" href="' + data[i].data.url_video + '"><span class="glyphicon glyphicon-film"></span></a>'*/
            ]);
        }

        mediathekTable.draw();

        $('#queryInfoLabel').text('Search engine took ' + result.queryInfo.searchEngineTime + ' ms, filtering out of ' + result.queryInfo.resultCount + ' results and sorting by relevance took ' + result.queryInfo.filterTime + ' ms');
    });

    function createPlayButton(title, url) {
        return '<a target="_blank" href="' + url + '" onclick="playVideo(\'' + title + '\',\'' + url + '\'); return false;"><span class="glyphicon glyphicon-film"></span></a>';
    }

    function playVideo(title, url) {
        var dialog = bootbox.dialog({
            title: title,
            message: '<video class="video-js" controls preload="auto"><source src="' + url + '" type="video/mp4"></video>',
            backdrop: true,
            onEscape: true
        });
    }

    $(function() { //jquery ready, page loaded
        mediathekTable = $('#mediathek').DataTable({
            columns: [{
                    width: "10%"
                }, {
                    width: "50%"
                },
                null,
                null,
                null,
                null,
                null
            ],
            searching: false,
            ordering: false,
            info: true
        });

        $('#websiteNamesMultiselect').multiselect({
            enableClickableOptGroups: true,
            disableIfEmpty: true,
            disabledText: 'none available',
            includeSelectAllOption: true,
            selectAllValue: 'select-all',
            onChange: (option, checked, select) => {
                if (option == undefined) {
                    if (!checked) selectedWebsiteNames.clear();
                    else selectedWebsiteNames = new Set(websiteNames);
                } else {
                    let website = option[0].value;

                    if (checked) {
                        selectedWebsiteNames.add(website);
                    } else {
                        selectedWebsiteNames.delete(website);
                    }
                }
                websiteNamesMultiselectChangedWhileOpen = true;
                query();
            },
            onDropdownHide: () => {
                if (websiteNamesMultiselectChangedWhileOpen) {
                    //query();
                    websiteNamesMultiselectChangedWhileOpen = false;
                }
            },
            buttonText: (options, select) => {
                if (options.length === 0) {
                    return 'Websites';
                } else if (options.length > 3) {
                    return options.length + ' websites selected';
                } else if (options.length == websiteNames.length) {
                    return 'All Websites';
                } else {
                    var labels = [];
                    options.each(function() {
                        if ($(this).attr('label') !== undefined) {
                            labels.push($(this).attr('label'));
                        } else {
                            labels.push($(this).html());
                        }
                    });
                    return labels.join(', ') + '';
                }
            },
            buttonTitle: (options, select) => {
                var labels = [];
                options.each(function() {
                    labels.push($(this).text());
                });
                return labels.join(' - ');
            }
        });
        socket.emit('getWebsiteNames');

        $('#queryInput').on('input', () => query());
        $('#queryField input:radio').change(() => query());
    });
</script>

<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">MediathekViewWeb</a>
            </div>
            <ul class="nav navbar-nav">
            </ul>
        </div>
    </nav>

    <div class="container">

        <div class="input-group" id="queryField">
            <span class="input-group-addon">Query</span>
            <input type="text" class="form-control" id="queryInput">

            <span class="input-group-addon">
              <input type="radio" name="searchmode" value="and" id="andRadioButton" checked> AND</input>
            </span>

            <span class="input-group-addon">
              <input type="radio" name="searchmode" value="or" id="orRadioButton"> OR</input>
            </span>
        </div>

        <br>

        <div class="panel panel-default">
            <div class="panel-heading">Filters</div>
            <div class="panel-body">
                <select id="websiteNamesMultiselect" multiple="multiple">
                </select>
            </div>
        </div>

        <br>

        <table id="mediathek" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Website</th>
                    <th>Title</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Duration</th>
                    <th>Size</th>
                    <th>Url</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <label id="queryInfoLabel"></label>

    </div>

    <script type="text/javascript">
        //$('#addDownloadModal').modal('show');
    </script>
</body>


</html>
