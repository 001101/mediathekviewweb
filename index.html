<!DOCTYPE html>
<html lang="en">

<head>
    <title>MediathekViewWeb</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../static/index.css">
    <link rel="stylesheet" href="../../static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../static/DataTables/datatables.min.css" />
    <script src="../../static/jquery.min.js"></script>
    <script src="../../static/js.cookie.js"></script>
    <script src="../../static/bootstrap/js/bootstrap.min.js"></script>
    <script src="../../socket.io/socket.io.js"></script>
    <script src="../../static/moment-with-locales.min.js"></script>
    <script src="../../static/DataTables/datatables.min.js"></script>
    <script src="../../static/lodash.min.js"></script>
</head>

<script>
    var socket = io();
    var currentPage = 0;
    var itemsPerPage = 15;
    var mediathekTable;
    var connectingModal;
    var indexingModal;
    var uid;
    var pv_id = randomString(6);
    var playingInterval;

    var locale = window.navigator.userLanguage || window.navigator.language;
    moment.locale(locale);

    Number.prototype.pad = function(size) {
        var s = String(this);
        while (s.length < (size || 2)) {
            s = "0" + s;
        }
        return s;
    }

    function modalIsOpen(modalDOM) {
        return (modalDOM.data('bs.modal') || {}).isShown;
    }

    function randomString(len) {
        var text = "";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

        for (var i = 0; i < len; i++)
            text += possible.charAt(Math.floor(Math.random() * possible.length));

        return text;
    }

    function formatBytes(bytes, decimals) {
        if (!(parseInt(bytes) >= 0)) return '?';
        else if (bytes == 0) return '0 Byte';

        var k = 1000;
        var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
    }

    function track(action) {
        let date = new Date();
        socket.emit('track', {
            uid: uid,
            pv_id: pv_id,
            ua: navigator.userAgent,
            lang: navigator.language,
            res: window.screen.width + "x" + window.screen.height,
            urlref: document.referrer,
            action_name: action,
            h: date.getHours(),
            m: date.getMinutes(),
            s: date.getSeconds(),
            rand: randomString(10),
            href: window.location.href
        });
    }

    if (typeof(Storage) !== "undefined") {
        uid = localStorage.getItem('uid');
    }
    if (!!uid) {
        uid = uid.trim();
    } else {
        uid = Cookies.get('uid');
        if (!!uid) {
            uid = uid.trim();
        }
    }
    if (!!uid && uid.length == 32) {
        track('index');
    } else {
        socket.on('uid', (_uid) => {
            localStorage.setItem('uid', _uid);
            Cookies.set('uid', _uid, {
                expires: 99999
            });
            uid = _uid;

            track('index');
        });
        socket.emit('requestUid');
    }

    setInterval(() => {
        if (socket.connected) {
            track('heartbeat');
        }
    }, 20 * 60 * 1000); //every 20 minutes

    socket.on('indexState', (state) => {
        let parsingProgress = (state.parserProgress * 100).toFixed(0);
        let indexingProgress = (state.indexingProgress * 100).toFixed(0);
        $('#parsingProgressbar').css('width', (parsingProgress + '%')).text(parsingProgress + '%');
        $('#indexingProgressbar').css('width', (indexingProgress + '%')).text(indexingProgress + '%');
        $('#indexingMessage').text(state.entries);
        $('#indexingTimeLabel').text((state.time / 1000).toFixed(0) + ' Sekunden');

        console.log(state);
        if (!state.done && !state.error) {
            if (!modalIsOpen(indexingModal)) {
                indexingModal.modal('show');
            }
        } else if (state.error) {
            $('#indexingMessage').text(state.error);
            setTimeout(() => indexingModal.modal('hide'), 3000);
        } else {
            indexingModal.modal('hide');
            currentPage = 0;
            query();
        }
    });

    function trackQuery() {
        trackQuery = _.debounce(() => {
            track('query');
        }, 2000);
        trackQuery();
    }

    function query() {
        query = _.throttle(() => {
            let queryString = $('#queryInput').val().trim();
            //let searchTopic = $('#queryField input:radio:checked').val();
            let future = !!$('#futureCheckbox').prop('checked');
            let fuzzy = !!$('#fuzzyCheckbox').prop('checked');


            let queryObj = {
                queryString: queryString,
                searchTopic: 'auto',
                future: future,
                fuzzy: fuzzy,
                from: currentPage * itemsPerPage,
                size: itemsPerPage
            };

            socket.emit('queryEntry', queryObj, (result) => {
                handleQueryResult(result);
            });

            trackQuery();
        }, 250);
        query();
    }

    function handleQueryResult(result) {
        mediathekTable.clear();

        for (var i = 0; i < result.results.length; i++) {
            let data = result.results[i];
            data.dateString = moment.unix(data.timestamp).format('L');
            data.timeString = moment.unix(data.timestamp).format('LT');

            let durationMoment = moment.duration(data.duration, 'seconds');
            let minutes = (durationMoment.hours() * 60 + durationMoment.minutes()).pad(2);
            let seconds = durationMoment.seconds().pad(2);
            data.durationString = isNaN(data.duration) ? '?' : (minutes + ':' + seconds);

            mediathekTable.row.add(data);
        }

        mediathekTable.draw();

        let actualPagesCount = Math.ceil(result.queryInfo.totalResults / itemsPerPage);
        shownPagesCount = Math.min(actualPagesCount, Math.floor(10000 / itemsPerPage));

        createPagination(shownPagesCount);

        $('#queryInfoLabel').text('Die Suchmaschine brauchte ' + result.queryInfo.searchEngineTime + ' ms, zeige Treffer ' + Math.min(result.queryInfo.totalResults, (currentPage * itemsPerPage + 1)) +
            ' bis ' + Math.min(result.queryInfo.totalResults, ((currentPage + 1) * itemsPerPage)) + ' von insgesamt ' + result.queryInfo.totalResults + ' Treffern.');
    }

    function createPaginationButton(text, active, enabled, callback) {
        let button = $('<li>').addClass(active ? 'active' : '').addClass(enabled ? '' : 'disabled').append($('<a>', {
            href: '#',
            text: text
        }));

        if (enabled && !active) {
            button.click(() => {
                callback();
                query();
            });
        }

        return button;
    }

    function createPagination(totalPages) {
        let pagination = $('#pagination');
        pagination.empty();

        let backButton = createPaginationButton('Zurück', false, currentPage > 0, () => {
            currentPage--;
        });
        pagination.append(backButton);

        let pagingBegin = Math.max(0, currentPage - 2 - (2 - Math.min(2, totalPages - (currentPage + 1))));
        let pagingEnd = Math.min(totalPages, pagingBegin + 5);

        for (let i = pagingBegin; i < pagingEnd; i++) {
            let button = createPaginationButton(i + 1, currentPage == i, true, () => {
                currentPage = i;
            });
            pagination.append(button);
        }

        let nextButton = createPaginationButton('Nächste', false, currentPage < (totalPages - 1), () => {
            currentPage++;
        });
        pagination.append(nextButton);
    }


    function getContentLength(url, callback) {
        socket.emit('getContentLength', url, (contentLength) => {
            callback(contentLength);
        });
    }

    function createSubtitleRow(text, url, filename, filesize) {
        let tableRow = $('<tr>');

        let downloadButton = $('<a>', {
            target: '_blank',
            href: url,
            download: filename
        });

        let downloadIcon = $('<span>').addClass('glyphicon glyphicon-save glyph-big');
        downloadButton.append(downloadIcon);

        let filesizeCell = $('<td>').text((isNaN(filesize) || !filesize) ? '?' : formatBytes(filesize, 2));

        tableRow.append($('<td>').text(text));
        tableRow.append(filesizeCell);
        tableRow.append($('<td>').append(downloadButton));

        return tableRow;
    }

    function createVideoRow(text, url, videoTitle, filename, filesize) {
        let tableRow = $('<tr>');

        let watchButton = $('<a>', {
            target: '_blank',
            href: url,
            click: () => {
                playVideo(videoTitle, url);
                return false;
            }
        });

        let eyeIcon = $('<span>').addClass('glyphicon glyphicon-eye-open glyph-big glyph-margin-right');
        watchButton.append(eyeIcon);

        let downloadButton = $('<a>', {
            target: '_blank',
            href: url,
            download: filename
        });

        let downloadIcon = $('<span>').addClass('glyphicon glyphicon-save glyph-big glyph-margin-left');
        downloadButton.append(downloadIcon);

        let filesizeCell = $('<td>').text((isNaN(filesize) || !filesize) ? '?' : formatBytes(filesize, 2));


        tableRow.append($('<td>').text(text));
        tableRow.append(filesizeCell);
        tableRow.append($('<td>').append(watchButton).append(downloadButton));

        return tableRow;
    }

    function hidePopoverIfNotHovered(button) {
        setTimeout(() => {
            let popoverID = button.attr('aria-describedby');
            let popover = $('#' + popoverID);
            if (popover.length) {
                if (!popover.is(':hover') && !button.is(':hover')) {
                    button.popover('hide');
                }
            }
        }, 150);
    }

    function createVideoActionButton(entry) {
        let highestQualityUrl = entry.url_video_hd ? entry.url_video_hd : (entry.url_video ? entry.url_video : entry.url_video_low);

        let button = $('<a>', {
            target: '_blank',
            href: entry.url_video,
            click: () => {
                playVideo(entry.title, highestQualityUrl);
                return false;
            }
        });

        let icon = $('<span>').addClass('glyphicon glyphicon-film glyph-big');
        button.append(icon);

        let table = $('<table>').addClass('table-condensed');
        table.append(`<thead>
              <tr>
                <th>Qualität</th>
                <th>Größe</th>
                <th>Aktion</th>
              </tr>
            </thead>`);


        let tableHead = $('<thead>');
        let tableBody = $('<tbody>');

        let filenamebase = entry.channel + ' - ' + entry.topic + ' - ' + entry.title + ' - ' + moment.unix(entry.timestamp).format('DD.MM.YYYY HH:mm');

        let lowRow, midRow, highRow, subtitleRow;

        if (entry.url_video_hd) {
            highRow = createVideoRow('Hoch', entry.url_video_hd, entry.title, filenamebase + entry.url_video_hd.split('.').pop());
            tableBody.append(highRow);
        }
        if (entry.url_video) {
            midRow = createVideoRow('Mittel', entry.url_video, entry.title, filenamebase + entry.url_video.split('.').pop(), entry.size);
            tableBody.append(midRow);
        }
        if (entry.url_video_low) {
            lowRow = createVideoRow('Niedrig', entry.url_video_low, entry.title, filenamebase + entry.url_video_low.split('.').pop());
            tableBody.append(lowRow);
        }
        if (entry.url_subtitle) {
            subtitleRow = createSubtitleRow('UT', entry.url_subtitle, filenamebase + entry.url_subtitle.split('.').pop());
            tableBody.append(subtitleRow);
        }

        table.append(tableBody);

        button.popover({
            trigger: 'manual',
            toggle: 'popover',
            placement: 'auto right',
            container: 'body',
            content: table,
            html: true,
            animation: true
        });

        let requestedFilesize = false;

        button.on('mouseenter', () => {
            button.popover('show');
            let popoverID = button.attr('aria-describedby');
            let popover = $('#' + popoverID);
            if (popover.length) {
                popover.on('mouseleave', () => {
                    hidePopoverIfNotHovered(button);
                });
            }

            if (!requestedFilesize) {
                requestedFilesize = true;
                if (highRow) {
                    getContentLength(entry.url_video_hd, (bytes) => {
                        highRow.find('td:eq(1)').text(formatBytes(bytes, 2));
                    });
                }
                if (midRow) {
                    getContentLength(entry.url_video, (bytes) => {
                        midRow.find('td:eq(1)').text(formatBytes(bytes, 2));
                    });
                }
                if (lowRow) {
                    getContentLength(entry.url_video_low, (bytes) => {
                        lowRow.find('td:eq(1)').text(formatBytes(bytes, 2));
                    });
                }
                if (subtitleRow) {
                    getContentLength(entry.url_subtitle, (bytes) => {
                        subtitleRow.find('td:eq(1)').text(formatBytes(bytes, 2));
                    });
                }
            }
        });

        button.on('mouseleave', () => {
            hidePopoverIfNotHovered(button);
        });

        return button;
    }

    function isFullscreen() {
        if (document.fullscreenElement) {
            return true;
        } else if (document.webkitFullscreenElement) {
            return true;
        } else if (document.mozFullScreenElement) {
            return true;
        } else if (document.msFullscreenElement) {
            return true;
        } else {
            return false;
        };
    }

    function requestFullscreen(element) {
        if (element.requestFullscreen) {
            element.requestFullscreen();
        } else if (element.webkitRequestFullScreen) {
            element.webkitRequestFullScreen();
        } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
        } else if (element.msRequestFullscreen) {
            element.msRequestFullscreen();
        }
    }

    function exitFullscreen() {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    }

    function getVideo() {
        return $('#videocontent > video')[0];;
    }

    function toggleVideoPause() {
        let video = getVideo();
        video.paused ? video.play() : video.pause();
    }

    function playVideo(title, url) {
        $('#videooverlay').show(200, () => {
            let videoplayer = $('<video>', {
                controls: '',
                width: '100%'
            }).append($('<source>', {
                src: url
            }));

            $('#videocontent').append(videoplayer);

            let video = videoplayer[0];

            videoplayer.click((e) => {
                if (e.offsetY < video.clientHeight * 0.92) { //to prevent pausing when clicking player controls
                    toggleVideoPause();
                }
            });

            videoplayer.dblclick(() => {
                if (isFullscreen()) {
                    exitFullscreen();
                } else {
                    requestFullscreen(video);
                }
            });
        }).focus();

        clearInterval(playingInterval); //in case it wasn't stopped for any reason
        playingInterval = setInterval(() => {
            if (socket.connected) {
                track('playing');
            }
        }, 2 * 60 * 1000); //every 2 minutes

        track('play');
    }

    function closeVideo() {
        $('#videocontent').empty();
        $('#videooverlay').hide(200);

        clearInterval(playingInterval);
    }

    function openContactsModal() {
        contactModal.modal('show');
        track('contact');
    }

    function returnEmptyString() {
        return '';
    }

    $(() => {
        $('#browserWarning').remove();

        connectingModal = $('#connectingModal');
        connectingModal.modal({
            backdrop: 'static',
            keyboard: false,
            show: false
        });

        indexingModal = $('#indexingModal');
        indexingModal.modal({
            backdrop: 'static',
            keyboard: false,
            show: false
        });

        contactModal = $('#contactModal');
        contactModal.modal({
            backdrop: true,
            keyboard: true,
            show: false
        });

        newDomainModal = $('#newDomainModal');
        newDomainModal.modal({
            backdrop: true,
            keyboard: true,
            show: false
        });

        socket.on('connect', () => {
            connectingModal.modal('hide');
        });

        socket.on('disconnect', () => {
            indexingModal.modal('hide');
            if (!modalIsOpen(connectingModal)) {
                connectingModal.modal('show');
            }
        });

        if (socket.disconnected) {
            if (!modalIsOpen(connectingModal)) {
                connectingModal.modal('show');
            }
        }

        mediathekTable = $('#mediathek').DataTable({
            columns: [{ //Sender
                width: '6%',
                data: null,
                render: returnEmptyString,
                createdCell: (td, cellData, rowData, row, col) => {
                    let link = $('<a>', {
                        target: '_blank',
                        text: rowData.channel,
                        href: rowData.url_website
                    });
                    $(td).append(link);
                }
            }, { //Thema
                width: '16%',
                data: 'topic'
            }, { //Title
                data: 'title'
            }, { //Date
                width: '8%',
                data: 'dateString'
            }, { //Time
                width: '7%',
                data: 'timeString'
            }, { //Duration
                width: '5%',
                data: 'durationString'
            }, { //Video
                width: '4%',
                data: null,
                render: returnEmptyString,
                createdCell: (td, cellData, rowData, row, col) => {
                    $(td).append(createVideoActionButton(rowData));
                }
            }],
            language: {
                url: '/static/dataTables.german.lang'
            },
            searching: false,
            ordering: false,
            info: false,
            paging: false
        });

        let newQuery = () => {
            currentPage = 0;
            query();
        };

        $('#queryInput').on('input', () => newQuery());
        $('#queryField input:radio').change(() => newQuery());
        $('#queryField input:checkbox').change(() => newQuery());

        $('#videocloseButton').click(() => {
            closeVideo();
        });

        $('#videooverlay').keydown((e) => {
            if (e.key == 'Escape' || e.keyCode == 27) {
                if (isFullscreen()) {
                    exitFullscreen();
                } else {
                    closeVideo();
                }
                e.preventDefault();
            } else if (e.key === ' ' || e.keyCode == 32) { //Space
                toggleVideoPause();
                e.preventDefault();
            }
        });

        $('#contactButton').click(() => openContactsModal());
        $('#githubButton').click(() => track('github'));
        $('#impressumButton').click(() => track('impressum'));
        $('#datenschutzButton').click(() => track('datenschutz'));
        $('#newDomainLink').click(() => track('newdomainlink'));

        if (window.location.hostname == "mediathekviewweb.batrick.de") {
            newDomainModal.modal('show');
        }

        query();
    });
</script>

<body>
    <div id="videooverlay" class="overlay initiallyHidden" tabindex="0">
        <a href="#" id="videocloseButton" class="closeButton">&times;</a>
        <div id="videocontent" class="overlay-content"></div>
    </div>

    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">MediathekViewWeb</a>
            </div>
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a id="contactButton" href="mailto:kontakt@mediathekviewweb.de" onclick="return false;">Kontakt</a></li>
                <li><a id="githubButton" target="_blank" href="https://github.com/bagbag/mediathekviewweb">GitHub</a></li>
                <li><a id="impressumButton" target="_blank" href="/impressum">Impressum</a></li>
                <li><a id="datenschutzButton" target="_blank" href="/datenschutz">Datenschutz</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="input-group" id="queryField">
            <span class="input-group-addon">Suche</span>
            <input type="text" style="min-width:13em" class="form-control" id="queryInput">

            <!--<span class="input-group-addon">
              <input type="radio" name="searchmode" value="true"> Titel &amp; Thema</input>
            </span>

            <span class="input-group-addon">
              <input type="radio" name="searchmode" value="false"> Titel</input>
            </span>

            <span class="input-group-addon">
              <input type="radio" name="searchmode" value="auto" checked> Auto</input>
            </span>-->

            <span class="input-group-addon">
              <input type="checkbox" name="fuzzy" id="fuzzyCheckbox"> Ähnlich</input>
            </span>

            <span class="input-group-addon">
              <input type="checkbox" name="future" id="futureCheckbox"> Zukunft</input>
            </span>

            <span class="input-group-btn">
              <button onclick="window.open('https://github.com/bagbag/mediathekviewweb', '_blank');" class="btn btn-default" type="button">Hilfe!</button>
            </span>
        </div>

        <br>
        <br>

        <table id="mediathek" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Sender</th>
                    <th>Thema</th>
                    <th>Titel</th>
                    <th>Datum</th>
                    <th>Zeit</th>
                    <th>Dauer</th>
                    <th>Video</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <div class="row">
            <div class="col-sm-7">
                <label id="queryInfoLabel"></label>
            </div>
            <div class="col-sm-5">
                <ul id="pagination" class="pagination paginationstyle">
                </ul>
            </div>
        </div>

        <div id="browserWarning" class="showafter1s" style="border: 3px solid red; padding: 10px; margin: 15px">
            <span><a target="_blank" href="https://github.com/bagbag/mediathekviewweb/issues/8">Dein Browser wird nicht unterstützt</a> oder Javascript ist deaktiviert</span>
        </div>

        <div id="connectingModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Keine Verbindung...</h4>
                    </div>
                    <div class="modal-body">
                        <span class="glyphicon glyphicon-repeat spinning"></span> Verbinden...
                    </div>
                </div>

            </div>
        </div>

        <div id="indexingModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Datenbank wird aktualisiert...</h4>
                    </div>
                    <div class="modal-body">
                        <div class="progress">
                            <div id="parsingProgressbar" class="progress-bar progress-bar-striped active" role="progressbar" style="min-width: 2em;">
                                0%
                            </div>
                        </div>
                        <div class="progress">
                            <div id="indexingProgressbar" class="progress-bar progress-bar-striped active" role="progressbar" style="min-width: 2em;">
                                0%
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4">Einträge:
                                <div id="indexingMessage">0</div>
                            </div>
                            <div class="col-sm-4">Dauer:
                                <div id="indexingTimeLabel">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="contactModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Kontakt</h4>
                    </div>
                    <div class="modal-body">
                        <p>Für gefundene Fehler oder Verbesserungsvorschläge verwende bitte die <a target="_blank" href="https://github.com/bagbag/mediathekviewweb/issues">Issues auf GitHub</a></p>
                        <p>Für alles andere oder im Fall, dass du kein GitHub Account hast/willst, schreibe mir eine Mail: <a target="_blank" href="mailto:kontakt@mediathekviewweb.de">kontakt@mediathekviewweb.de</a></p>
                    </div>
                </div>

            </div>
        </div>

        <div id="newDomainModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Neue Adresse</h4>
                    </div>
                    <div class="modal-body">
                        <p>Ab sofort ist MediathekViewWeb unter <a id="newDomainLink" target="_self" href="https://mediathekviewweb.de">mediathekviewweb.de</a> zu erreichen!</p>
                    </div>
                </div>

            </div>
        </div>

    </div>
</body>

</html>
